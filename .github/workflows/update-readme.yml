name: è‡ªåŠ¨æ›´æ–° README.md

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'web/package.json'
      - 'web/src/**'
      - '.github/workflows/update-readme.yml'

  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 (UTC 0:00) è‡ªåŠ¨è¿è¡Œ
    - cron: '0 0 * * 1'

jobs:
  update-readme:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥æäº¤æ›´æ”¹

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd web
          npm ci

      - name: è¿è¡Œé¡¹ç›®ç»“æ„åˆ†æ
        run: |
          node scripts/analyze-project-structure.js

      - name: è¿è¡ŒæŠ€æœ¯æ ˆæ£€æµ‹
        run: |
          node scripts/detect-tech-stack.js

      - name: æ›´æ–° README.md
        run: |
          node scripts/update-readme.js

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ README.md æ— éœ€æ›´æ–°"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… README.md å·²æ›´æ–°"
          fi

      - name: æäº¤æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
          git add README.md
          git add project-structure.json tech-stack.json readme-update-report.json

          # æäº¤
          git commit -m "docs: è‡ªåŠ¨æ›´æ–° README.md

          - ğŸ”„ æ›´æ–°é¡¹ç›®ç‰ˆæœ¬å’ŒæŠ€æœ¯æ ˆä¿¡æ¯
          - ğŸ“Š æ›´æ–°é¡¹ç›®ç»“æ„ç»Ÿè®¡
          - ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ

          Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

          # æ¨é€
          git push

      - name: ä¸Šä¼ åˆ†ææŠ¥å‘Šä¸ºæ„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: readme-update-reports
          path: |
            project-structure.json
            tech-stack.json
            readme-update-report.json
          retention-days: 30

      - name: åˆ›å»ºæ›´æ–°æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š README æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f readme-update-report.json ]; then
            echo "### âœ… æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ›´æ–°æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æå–ç‰ˆæœ¬ä¿¡æ¯
            VERSION=$(node -p "require('./web/package.json').version")
            echo "**é¡¹ç›®ç‰ˆæœ¬**: v$VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ğŸ“¦ æ›´æ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ ‡é¢˜ç‰ˆæœ¬å·" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æŠ€æœ¯æ ˆ Badges" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… é¡¹ç›®æ¦‚è¿°" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æŠ€æœ¯æ ˆè¡¨æ ¼" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… é¡¹ç›®ç»“æ„" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
